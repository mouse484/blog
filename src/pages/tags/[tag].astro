---
import { getCollection } from 'astro:content'
import Layout from '../../layouts/Layout.astro'
import { escapeTag } from '../../utils/path'
import PostList from '../../components/PostList.astro'

export async function getStaticPaths() {
  const tags = new Map<string, string>()
  const posts = (await getCollection('blog')).map((post) => {
    return {
      ...post,
      tags: (post.data.tags ?? []).map((_tag) => {
        const tag = escapeTag(_tag)
        tags.set(tag, _tag)
        return tag
      }),
    }
  })

  return [...tags].map(([tag, rawName]) => {
    return {
      params: { tag },
      props: {
        posts: posts.filter((post) => post.tags?.includes(tag)),
        tagName: rawName,
      },
    }
  })
}

const { tag } = Astro.params
const { posts, tagName } = Astro.props
---

<Layout>
  <h2 transition:name={`tag-${tag}`}>Tag: {tagName}</h2>
  <PostList posts={posts} />
</Layout>
